# Cell 27: Compare same store sales YoY and flag merchants without prior year data

# Extract year and month from txn_year_month
gbs_mids_grouped_1 = gbs_mids_grouped_1.withColumn(
    "year", F.substring("txn_year_month", 1, 4).cast("int")
).withColumn(
    "month", F.substring("txn_year_month", 5, 2).cast("int")
)

# Create a copy of the dataframe for prior year comparison
prior_year_df = gbs_mids_grouped_1.select(
    "state", 
    "naics3",
    "year",
    "month",
    "txn_year_month",
    "total_tran_amount",
    "merchant_key_count"
).withColumnRenamed("state", "prior_state"
).withColumnRenamed("naics3", "prior_naics3"
).withColumnRenamed("year", "prior_year"
).withColumnRenamed("txn_year_month", "prior_txn_year_month"
).withColumnRenamed("total_tran_amount", "prior_year_amount"
).withColumnRenamed("merchant_key_count", "prior_merchant_count")

# Join current data with prior year data (same month, previous year)
yoy_comparison = gbs_mids_grouped_1.join(
    prior_year_df,
    (gbs_mids_grouped_1.state == prior_year_df.prior_state) &
    (gbs_mids_grouped_1.naics3 == prior_year_df.prior_naics3) &
    (gbs_mids_grouped_1.month == prior_year_df.month) &
    (gbs_mids_grouped_1.year == prior_year_df.prior_year + 1),
    "left"
)

# Create flag for merchants without prior year data
yoy_comparison = yoy_comparison.withColumn(
    "has_prior_year_data",
    F.when(F.col("prior_year_amount").isNotNull(), True).otherwise(False)
)

# Calculate year-over-year growth rate
yoy_comparison = yoy_comparison.withColumn(
    "yoy_growth_rate",
    F.when(
        F.col("prior_year_amount").isNotNull() & (F.col("prior_year_amount") != 0),
        (F.col("total_tran_amount") - F.col("prior_year_amount")) / F.col("prior_year_amount")
    ).otherwise(None)
)

# Display the comparison results with relevant columns
display(yoy_comparison.select(
    "state", 
    "naics3", 
    "txn_year_month", 
    "prior_txn_year_month",
    "total_tran_amount", 
    "prior_year_amount", 
    "merchant_key_count",
    "prior_merchant_count",
    "has_prior_year_data", 
    "yoy_growth_rate"
).orderBy("state", "naics3", "txn_year_month"))

# Summary of merchants without prior year data
no_prior_year_summary = yoy_comparison.filter(~F.col("has_prior_year_data")).groupBy("state", "naics3").count()
display(no_prior_year_summary.orderBy(F.desc("count")))